include:
  - project: snum/detn/gmcd/cicd/cicd-configuration
    ref: ht-rework
    file: "trigger-project/.default-conf.yml"
    rules:
      - exists:
          paths:
            - "trigger-project/.default-conf.yml"
          project: snum/detn/gmcd/cicd/cicd-configuration
          ref: ht-rework
  - project: snum/detn/gmcd/cicd/cicd-configuration
    ref: ht-rework
    file: "trigger-project/.${CI_PROJECT_NAME}-conf.yml"
    rules:
      - exists:
          paths:
            - "trigger-project/.${CI_PROJECT_NAME}-conf.yml"
          project: snum/detn/gmcd/cicd/cicd-configuration
          ref: ht-rework

trigger-gitlab:
  stage: trigger
  rules:
    - if: $GITLAB_TRIGGER_CONFIGURATION == null
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /ci-clean-/
      when: never
    - when: always
  tags:
    - $TRIGGER_RUNNER_TAGS
  needs:
    - trigger-get-script
  image: ${REGISTRY_DOMAIN}${CICD_NAMESPACE}${PYTHON_PROCESS_PATH}:${PYTHON_PROCESS_TAG}
  script:
    - echo GITLAB_TRIGGER_CONFIGURATION -- $GITLAB_TRIGGER_CONFIGURATION

    - python3 ${PYTHON_TRIGGER_SCRIPT}
      --debug-enabled ${CI_DEBUG}
      --token ${CI_JOB_TOKEN}
      --project ${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}
      --branch ${CI_COMMIT_BRANCH}
      --description "${CI_COMMIT_MESSAGE}"
      --commit-before-sha ${CI_COMMIT_BEFORE_SHA}
      --commit-sha ${CI_COMMIT_SHA}
      --config "${GITLAB_TRIGGER_CONFIGURATION}"
      

trigger-jenkins:
  stage: trigger
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /ci-clean-/
      when: never
    - if: $JENKINS_TRIGGER_CONFIGURATION == null
      when: never
    - when: always
  tags:
    - $TRIGGER_RUNNER_TAGS
  image: ${REGISTRY_DOMAIN}${CICD_NAMESPACE}${PYTHON_PROCESS_PATH}:${PYTHON_PROCESS_TAG}
  needs:
    - trigger-get-script
  script:
    - echo JENKINS_TRIGGER_CONFIGURATION -- $JENKINS_TRIGGER_CONFIGURATION

    - python3 ${PYTHON_TRIGGER_SCRIPT}
      --debug-enabled ${CI_DEBUG}
      --project ${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}
      --branch ${CI_COMMIT_BRANCH}
      --commit-before-sha ${CI_COMMIT_BEFORE_SHA}
      --commit-sha ${CI_COMMIT_SHA}
      --config "${JENKINS_TRIGGER_CONFIGURATION}"
